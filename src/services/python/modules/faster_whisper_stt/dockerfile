# ==============================
# STAGE 1: Builder (for dependencies)
# ==============================
FROM nvidia/cuda:12.3.2-cudnn9-runtime-ubuntu22.04 AS builder

# Prevent apt from asking interactive questions
ENV DEBIAN_FRONTEND=noninteractive

# Install Python and build tools
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Create a virtual environment
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy and install only requirements first (for layer caching)
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt


# ==============================
# STAGE 2: Runtime
# ==============================
FROM nvidia/cuda:12.3.2-cudnn9-runtime-ubuntu22.04

# Security: run as non-root user
RUN useradd --create-home --shell /bin/bash appuser
USER appuser
WORKDIR /home/appuser/app

# Copy virtual environment from builder
COPY --from=builder --chown=appuser:appuser /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy application code
COPY --chown=appuser:appuser whisper_stt ./whisper_stt

# Optional: copy a simple test script or CLI entrypoint
# COPY --chown=appuser:appuser app.py .

# Ensure ffmpeg is available (required by faster-whisper)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*